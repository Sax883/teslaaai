<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TelsAAI Admin Dashboard</title>
    <link rel="stylesheet" href="./css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
</head>
<body>

    <div id="login-container" class="active">
        <h2>Admin Login</h2>
        <input type="text" id="admin-username" placeholder="Username">
        <input type="password" id="admin-password" placeholder="Password">
        <button onclick="handleLogin()">Sign In</button>
        <p id="login-message" class="error-message"></p>
    </div>

    <div id="dashboard-container">
        <header>
            <h1>TelsAAI Admin Panel</h1>
            <div id="admin-info">
                <span id="admin-name"></span>
                <button onclick="handleLogout()">Logout</button>
            </div>
        </header>

        <div id="main-content">
            
            <section class="admin-section client-list-section">
                <h2>ðŸ“Š Client Financial Overview</h2>
                <table id="client-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Balance ($)</th>
                            <th>Investment ($)</th>
                            <th>Profit ($)</th>
                            <th>Next Payout</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </section>

            <section class="admin-section pending-claims-section">
                <h2>ðŸ”” Pending Transaction Claims</h2>
                <div id="pending-claims-list">
                    <p id="no-claims-message">No pending claims currently requiring verification.</p>
                </div>
            </section>

            <section class="admin-section chat-section">
                <h2>ðŸ’¬ Live Client Support</h2>
                <div class="chat-sidebar">
                    <h3>Online Clients (<span id="online-client-count">0</span>)</h3>
                    <ul id="online-clients-list">
                        </ul>
                </div>
                <div class="chat-main">
                    <div id="chat-header">
                        <span id="chat-client-id">Select a Client</span>
                    </div>
                    <div id="chat-messages">
                        </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input" placeholder="Type a reply..." disabled>
                        <button id="send-chat-button" onclick="sendAdminReply()" disabled>Send</button>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <div id="update-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3>Update Financials for Client ID: <span id="modal-client-id"></span></h3>
            <label for="modal-balance">Balance:</label>
            <input type="number" id="modal-balance" step="0.01">
            <label for="modal-investment">Investment:</label>
            <input type="number" id="modal-investment" step="0.01">
            <label for="modal-profit">Profit:</label>
            <input type="number" id="modal-profit" step="0.01">
            <label for="modal-payout">Next Payout Date (YYYY-MM-DD):</label>
            <input type="text" id="modal-payout" placeholder="YYYY-MM-DD or NULL">
            <button onclick="submitUpdate()">Update Client</button>
            <p id="modal-message" class="error-message"></p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script> 

    <script>
        // --- CONFIGURATION ---
        // CRITICAL FIX 1: Replaced 'http://localhost:3000' with the live Render URL
        const RENDER_URL = 'https://teslaaai.onrender.com';
        const API_BASE_URL = RENDER_URL + '/api'; 
        
        // CRITICAL FIX 2: Fixed the Socket.IO connection URL
        const socket = io(RENDER_URL);

        // --- GLOBAL STATE ---
        let adminToken = localStorage.getItem('adminToken');
        let selectedClientID = null;
        let onlineClients = [];

        // --- AUTHENTICATION & INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            if (adminToken) {
                verifyTokenAndLoadDashboard();
            } else {
                showLogin();
            }
        });

        function showLogin() {
            document.getElementById('login-container').classList.add('active');
            document.getElementById('dashboard-container').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('login-container').classList.remove('active');
            document.getElementById('dashboard-container').style.display = 'block';
            fetchClients();
            socket.emit('join-admin-room');
        }

        async function handleLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const messageEl = document.getElementById('login-message');
            messageEl.textContent = '';

            try {
                const response = await fetch(API_BASE_URL + '/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('adminToken', data.token);
                    adminToken = data.token;
                    verifyTokenAndLoadDashboard();
                } else {
                    messageEl.textContent = data.message || 'Login failed.';
                }
            } catch (error) {
                console.error('Login error:', error);
                messageEl.textContent = 'Connection Error: Could not reach the server (Is the server.js running?).';
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            location.reload(); // Simple way to reset state and show login
        }

        async function verifyTokenAndLoadDashboard() {
            try {
                const response = await fetch(API_BASE_URL + '/admin/profile', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('admin-name').textContent = data.name;
                    showDashboard();
                } else {
                    handleLogout(); // Token expired or invalid
                }
            } catch (error) {
                console.error('Token verification error:', error);
                document.getElementById('login-message').textContent = 'Server Error during verification.';
                handleLogout();
            }
        }

        // --- CLIENT DATA HANDLING ---

        async function fetchClients() {
            try {
                const response = await fetch(API_BASE_URL + '/admin/clients', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const clients = await response.json();
                    renderClientTable(clients);
                } else {
                    console.error('Failed to fetch clients:', response.statusText);
                }
            } catch (error) {
                console.error('Fetch clients error:', error);
            }
        }

        function renderClientTable(clients) {
            const tbody = document.getElementById('client-table').querySelector('tbody');
            tbody.innerHTML = '';
            clients.forEach(client => {
                const row = tbody.insertRow();
                row.insertCell().textContent = client.clientID;
                row.insertCell().textContent = client.email;
                row.insertCell().textContent = `$${parseFloat(client.balance).toFixed(2)}`;
                row.insertCell().textContent = `$${parseFloat(client.investment).toFixed(2)}`;
                row.insertCell().textContent = `$${parseFloat(client.profit).toFixed(2)}`;
                row.insertCell().textContent = client.nextPayout || 'N/A';

                const actionCell = row.insertCell();
                const updateBtn = document.createElement('button');
                updateBtn.textContent = 'Update';
                updateBtn.onclick = () => openUpdateModal(client);
                actionCell.appendChild(updateBtn);
            });
        }

        // --- CLIENT UPDATE MODAL ---

        function openUpdateModal(client) {
            document.getElementById('modal-client-id').textContent = client.clientID;
            document.getElementById('modal-balance').value = parseFloat(client.balance).toFixed(2);
            document.getElementById('modal-investment').value = parseFloat(client.investment).toFixed(2);
            document.getElementById('modal-profit').value = parseFloat(client.profit).toFixed(2);
            document.getElementById('modal-payout').value = client.nextPayout || '';
            document.getElementById('update-modal').style.display = 'flex';
            document.getElementById('modal-message').textContent = '';
        }

        function closeModal() {
            document.getElementById('update-modal').style.display = 'none';
        }

        async function submitUpdate() {
            const clientID = document.getElementById('modal-client-id').textContent;
            const messageEl = document.getElementById('modal-message');
            messageEl.textContent = '';
            
            const payload = {
                balance: document.getElementById('modal-balance').value,
                investment: document.getElementById('modal-investment').value,
                profit: document.getElementById('modal-profit').value,
                // Pass 'NULL' as a string if the field is empty to handle PostgreSQL NULL insertion
                nextPayout: document.getElementById('modal-payout').value || null 
            };

            try {
                const response = await fetch(`${API_BASE_URL}/admin/client/${clientID}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    messageEl.textContent = 'Update successful.';
                    messageEl.classList.remove('error-message');
                    messageEl.style.color = 'green';
                    fetchClients(); // Refresh client list
                    setTimeout(closeModal, 1000); // Close after showing success
                } else {
                    messageEl.textContent = data.message || 'Update failed.';
                    messageEl.classList.add('error-message');
                }
            } catch (error) {
                console.error('Update error:', error);
                messageEl.textContent = 'A network error occurred.';
                messageEl.classList.add('error-message');
            }
        }

        // --- PENDING CLAIMS HANDLING ---
        
        async function verifyTransaction(transactionID, clientID, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/transaction/${transactionID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ status, clientID }) // clientID is critical for broadcast
                });

                if (response.ok) {
                    alert(`Transaction ${transactionID} marked as ${status}. Client will be notified.`);
                    // Remove the claim from the pending list
                    document.getElementById(`claim-${transactionID}`).remove();
                    
                    // Check if the list is empty and show the "No claims" message
                    const listContainer = document.getElementById('pending-claims-list');
                    if (!listContainer.querySelector('.pending-claim-item')) {
                        document.getElementById('no-claims-message').style.display = 'block';
                    }
                } else {
                    const data = await response.json();
                    alert(`Failed to update transaction: ${data.message}`);
                }
            } catch (error) {
                console.error('Verification error:', error);
                alert('A network error occurred while updating the transaction.');
            }
        }

        // --- SOCKET.IO CHAT AND REAL-TIME UPDATES ---

        socket.on('connect', () => {
            console.log('Connected to server via Socket.IO');
            if (adminToken) {
                socket.emit('join-admin-room');
            }
        });

        socket.on('online-clients', (clients) => {
            onlineClients = clients;
            const listEl = document.getElementById('online-clients-list');
            listEl.innerHTML = '';
            document.getElementById('online-client-count').textContent = clients.length;
            
            clients.forEach(clientID => {
                const li = document.createElement('li');
                li.textContent = clientID;
                li.onclick = () => selectClientForChat(clientID);
                if (clientID === selectedClientID) {
                    li.classList.add('selected');
                }
                listEl.appendChild(li);
            });
        });

        socket.on('new-pending-claim', (claim) => {
            document.getElementById('no-claims-message').style.display = 'none';
            
            const listContainer = document.getElementById('pending-claims-list');
            const claimEl = document.createElement('div');
            claimEl.className = 'pending-claim-item';
            claimEl.id = `claim-${claim.transactionID}`;
            
            claimEl.innerHTML = `
                <p><strong>Client ID:</strong> ${claim.clientID}</p>
                <p><strong>Type:</strong> ${claim.type}</p>
                <p><strong>Amount:</strong> $${parseFloat(claim.amount).toFixed(2)}</p>
                <div class="claim-actions">
                    <button class="approve-btn" onclick="verifyTransaction('${claim.transactionID}', '${claim.clientID}', 'Completed')">Approve</button>
                    <button class="decline-btn" onclick="verifyTransaction('${claim.transactionID}', '${claim.clientID}', 'Declined')">Decline</button>
                </div>
            `;
            listContainer.prepend(claimEl);
        });

        // --- CHAT LOGIC ---

        function selectClientForChat(clientID) {
            selectedClientID = clientID;
            document.getElementById('chat-client-id').textContent = `Chatting with: ${clientID}`;
            document.getElementById('chat-messages').innerHTML = ''; // Clear old messages
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-chat-button').disabled = false;

            // Highlight the selected client in the list
            document.querySelectorAll('#online-clients-list li').forEach(li => {
                li.classList.remove('selected');
                if (li.textContent === clientID) {
                    li.classList.add('selected');
                }
            });
            
            // Request chat history
            socket.emit('get-chat-history', clientID);
        }

        socket.on('chat-history', (history) => {
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = '';
            history.forEach(msg => {
                appendChatMessage(msg);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('client-message', (msg) => {
            if (msg.senderID === selectedClientID) {
                appendChatMessage(msg);
            }
            // Optional: Highlight the client in the list to show new message
            const clientItem = document.querySelector(`#online-clients-list li:has(span[data-id="${msg.senderID}"])`);
            if (clientItem) {
                clientItem.classList.add('new-message'); 
            }
        });

        function sendAdminReply() {
            const inputEl = document.getElementById('chat-input');
            const message = inputEl.value.trim();

            if (message && selectedClientID) {
                const msgData = {
                    recipientID: selectedClientID,
                    message: message
                };
                
                socket.emit('admin-reply', msgData);

                // Display the sent message immediately
                appendChatMessage({
                    sender: 'admin',
                    text: message,
                    timestamp: Date.now()
                });
                
                inputEl.value = '';
            }
        }
        
        // Listen for Enter key to send message
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendAdminReply();
            }
        });


        function appendChatMessage(msg) {
            const chatBox = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', msg.sender);
            
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageEl.innerHTML = `
                <div class="sender-name">${msg.sender === 'admin' ? 'Admin' : 'Client'}</div>
                <div class="message-text">${msg.text}</div>
                <div class="timestamp">${time}</div>
            `;
            chatBox.appendChild(messageEl);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll to bottom
        }

    </script>
</body>
</html>